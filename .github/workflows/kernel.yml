name: Build Kernel

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  Read-configuration:
    name: üêÇ Parse *.config.json
    runs-on: ubuntu-latest
    outputs:
      CONFIGS: ${{ steps.generate-matrix.outputs.CONFIGS }}
      BUILD_DATE: ${{ steps.generate-builddate.outputs.BUILDDATE }}
    steps:
      - name: üòÑ Checkout
        uses: actions/checkout@v4

      - name: üòÜ Generate Matrix
        id: generate-matrix
        run: |
          configs=$(jq -c -s '[.[][]]' Kernel/configs/*.config.json)
          echo "CONFIGS=$configs" >> "$GITHUB_OUTPUT"

      - name: ‚è∞ Set builddate
        id: generate-builddate
        run: echo "BUILDDATE=$(date +'%Y%m%d')" >> "$GITHUB_OUTPUT"

  Build-Kernel:
    name: üõ†Ô∏è Build ${{ matrix.CONFIG.kernelSource.name }}
    runs-on: ubuntu-latest
    needs: Read-configuration
    strategy:
      max-parallel: 4
      fail-fast: false
      matrix:
        CONFIG: ${{ fromJSON(needs.Read-configuration.outputs.CONFIGS) }}
    env:
      BUILD_DATE: "${{ needs.Read-configuration.outputs.BUILD_DATE }}"
      KERNEL_NAME: "${{ matrix.CONFIG.kernelSource.name }}"
      ARCH: "${{ matrix.CONFIG.arch }}"
      OUT_DIR: out
      ENABLE_CCACHE: "${{ matrix.CONFIG.enableCache }}"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install prerequisites
        run: |
          sudo apt-get update
          
